---
import Layout from "../../../layouts/Layout.astro";
import BreadCrumbs from "../../../components/BreadCrumbs.astro";
import PrendreRendezVousButtonHome from "../../../components/PrendreRendezVousButtonHome.astro";
import { sanityClient } from "../../../sanityClient";
import { optimizeCloudinaryUrl } from "../../../lib/optimizeCloudinaryUrl";

// 1) Génération des chemins dynamiques pour chaque slug de robe
export async function getStaticPaths() {
  const slugs = await sanityClient.fetch(`
    *[_type == "robe" && category == "robes-de-mariee" && sousCategorie == "forme-princesse"].slug.current
  `);
  return slugs.map((s) => ({ params: { slug: s } }));
}

// 2) Récupération du slug courant
const { slug } = Astro.params;

// 3) Fetch de la robe demandée
const robeData = await sanityClient.fetch(
  `
    *[_type == "robe"
      && category == "robes-de-mariee"
      && sousCategorie == "forme-princesse"
      && slug.current == $slug][0]{
        title,
        metaDescription,
        dressName,
        descriptionCourte,
        category,
        sousCategorie,
        "imagesCloudinary": imagesCloudinary[]{ url, alt }
    }
  `,
  { slug }
);

if (!robeData) {
  throw new Error(`Robe introuvable pour le slug : ${slug}`);
}

// 4) Mapping et optimisation des images pour le slider
const robe = {
  ...robeData,
  images: (robeData.imagesCloudinary || []).map((img) => ({
    alt: img.alt,
    optimized: {
      tablet: optimizeCloudinaryUrl(img.url, { w: 800, h: 1200, crop: "fill" }),
      mobile: optimizeCloudinaryUrl(img.url, { w: 400, h: 600, crop: "fill" }),
    },
  })),
};

// 5) Fetch des suggestions (autres robes)
const othersData = await sanityClient.fetch(
  `
    *[_type == "robe"
      && category == "robes-de-mariee"
      && sousCategorie == "forme-princesse"
      && slug.current != $slug]{
        "slug": slug.current,
        dressName,
        category,
        sousCategorie,
        "imagesCloudinary": imagesCloudinary[]{ url, alt }
    }
  `,
  { slug }
);
const randomDresses = (othersData || [])
  .map((d) => ({
    ...d,
    images: (d.imagesCloudinary || []).map((img) => ({
      alt: img.alt,
      optimized: {
        tablet: optimizeCloudinaryUrl(img.url, {
          w: 400,
          h: 600,
          crop: "fill",
        }),
        mobile: optimizeCloudinaryUrl(img.url, {
          w: 200,
          h: 300,
          crop: "fill",
        }),
      },
    })),
  }))
  .sort(() => 0.5 - Math.random())
  .slice(0, 4);
---

<Layout title={robe.title} description={robe.metaDescription}>
  <!-- Slider -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"
  />
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <div
    class="mt-20 max-w-7xl mx-auto px-4 lg:px-6 flex flex-col lg:flex-row gap-10"
  >
    <section class="w-full lg:w-3/5">
      <BreadCrumbs />
      <div class="relative w-full max-w-md h-[600px] mx-auto overflow-hidden">
        <div
          class="swiper-container rounded-2xl shadow-lg border border-[#C5A880]"
        >
          <div class="swiper-wrapper">
            {
              robe.images.map((img, i) => (
                <div class="swiper-slide" key={i}>
                  <img
                    src={img.optimized.tablet}
                    alt={img.alt}
                    class="object-cover w-full h-full rounded-2xl"
                    loading="lazy"
                  />
                </div>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <section class="w-full lg:w-2/5 flex flex-col justify-center">
      <h1 class="text-4xl font-vibes text-[#af7749] mb-4">
        Robe de Mariée {
          robe.dressName.charAt(0).toUpperCase() +
            robe.dressName.slice(1).toLowerCase()
        }
      </h1>
      <p class="text-gray-700 text-lg leading-relaxed">
        {robe.descriptionCourte}
      </p>
      <div class="mt-10 text-center">
        <PrendreRendezVousButtonHome />
      </div>
    </section>
  </div>

  <!-- Vous pourriez aussi aimer -->
  <div class="max-w-7xl mb-20 mx-auto px-6 mt-20">
    <h2 class="text-3xl font-playfair text-[#af7749] mb-8 text-center">
      Vous pourriez aussi aimer
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {
        randomDresses.map((d, i) => (
          <a
            key={i}
            href={`/robes-de-mariee/${d.sousCategorie}/${d.slug}`}
            class="relative rounded-2xl overflow-hidden h-[300px] shadow-md hover:shadow-lg transition-shadow"
          >
            <img
              src={d.images[0]?.optimized.mobile}
              alt={d.images[0]?.alt}
              class="absolute inset-0 w-full h-full object-cover"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-[#af7749] opacity-20" />
            <div class="absolute bottom-0 w-full p-4 text-center bg-gradient-to-t from-[#af7749] to-transparent">
              <p class="text-white font-vibes text-xl drop-shadow-lg">
                {d.dressName}
              </p>
            </div>
          </a>
        ))
      }
    </div>
  </div>

  <!-- Init Swiper -->
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      new Swiper(".swiper-container", {
        loop: true,
        slidesPerView: 1,
        autoplay: { delay: 3000 },
      });
    });
  </script>
</Layout>
