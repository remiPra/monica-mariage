---
import Layout from "../../../layouts/Layout.astro";
import BreadCrumbs from "../../../components/BreadCrumbs.astro";
import PrendreRendezVousButtonHome from "../../../components/PrendreRendezVousButtonHome.astro";
import { sanityClient } from "../../../sanityClient";
import { optimizeCloudinaryUrl } from "../../../lib/optimizeCloudinaryUrl";

// üîç DEBUG : dump complet de tous les docs "robe"
const allDocs = await sanityClient.fetch(`
  *[_type == "robe"]{
    _id,
    dressName,
    category,
    sousCategorie,
    "slug": slug.current,
    imagesCloudinary[]{ url, alt }
  }
`);
console.log("üöÄ SANITY ALL DOCS:", JSON.stringify(allDocs, null, 2));

// 1) getStaticPaths() filtr√© sur cat√©gorie + sousCat
export async function getStaticPaths() {
  const slugs = await sanityClient.fetch(`
    *[_type == "robe"
      && category == "robes-de-mariee"
      && sousCategorie == "forme-princesse"].slug.current
  `);
  return slugs.map((s) => ({ params: { slug: s } }));
}

// 2) Fetch de la robe courante
const { slug } = Astro.params;
const robe = await sanityClient.fetch(
  `
  *[_type == "robe"
    && category == "robes-de-mariee"
    && sousCategorie == "forme-princesse"
    && slug.current == $slug][0]{
      title,
      metaDescription,
      dressName,
      descriptionCourte,
      imagesCloudinary[]{ url, alt }
  }
`,
  { slug }
);

// 3) Fetch de tous les autres candidats, puis randomiser en JS
const others = await sanityClient.fetch(
  `
  *[_type == "robe"
    && category == "robes-de-mariee"
    && sousCategorie == "forme-princesse"
    && slug.current != $slug]{
      "slug": slug.current,
      dressName,
      imagesCloudinary[]{ url, alt }
  }
`,
  { slug }
);

// Tirage al√©atoire en JavaScript
const randomDresses = others.sort(() => 0.5 - Math.random()).slice(0, 4);
---

<Layout title={robe.title} description={robe.metaDescription}>
  <!-- Pr√©chargement pour LCP -->
  <link
    rel="preload"
    as="image"
    href={optimizeCloudinaryUrl(robe.imagesCloudinary[0].url, false)}
    fetchpriority="high"
  />

  <!-- Charger Swiper -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"
  />
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <!-- Contenu principal -->
  <div
    class="mt-20 max-w-7xl mx-auto px-4 lg:px-6 flex flex-col lg:flex-row gap-10"
  >
    <!-- Section gauche: slider -->
    <section class="w-full lg:w-[60%]">
      <BreadCrumbs />
      <div
        class="relative w-full max-w-[500px] h-[600px] mx-auto overflow-hidden"
      >
        <div
          class="swiper-container rounded-2xl shadow-lg border border-[#C5A880]"
        >
          <div class="swiper-wrapper">
            {
              robe.imagesCloudinary.map((img, i) => (
                <div class="swiper-slide" key={i}>
                  <img
                    src={optimizeCloudinaryUrl(img.url, false)}
                    alt={img.alt || robe.dressName}
                    class="object-cover w-full h-full rounded-2xl"
                    loading="lazy"
                  />
                </div>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Section droite: infos robe -->
    <section class="w-full lg:w-[40%] flex flex-col justify-center">
      <h1 class="text-4xl font-vibes text-[#af7749] mb-4">
        Robe de Mari√©e {robe.dressName}
      </h1>
      <p class="text-gray-700 text-lg leading-relaxed">
        {robe.descriptionCourte}
      </p>
      <div class="mt-10 w-full text-center">
        <PrendreRendezVousButtonHome />
      </div>
    </section>
  </div>

  <!-- "Vous pourriez aussi aimer" -->
  <div class="max-w-7xl mb-20 mx-auto px-6 mt-20">
    <h2
      class="text-[50px] font-cursive md:text-3xl font-playfair text-[#af7749] mb-8 text-center"
    >
      Vous pourriez aussi aimer
    </h2>

    <div
      class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4"
    >
      {
        randomDresses.map((dress, i) => (
          <a
            key={i}
            href={`/robes-de-mariee/forme-princesse/${dress.slug}`}
            class="relative text-center overflow-hidden border-[#322d25] cursor-pointer fade-in border rounded-2xl h-[300px] shadow-md"
          >
            <div class="absolute w-full h-full inset-0 bg-[#af7749] opacity-20 z-10" />
            {dress.imagesCloudinary && dress.imagesCloudinary[0] ? (
              <img
                src={optimizeCloudinaryUrl(
                  dress.imagesCloudinary[0].url,
                  false
                )}
                alt={dress.imagesCloudinary[0].alt || dress.dressName}
                class="absolute top-0 w-full h-full object-cover rounded hover:scale-105 transition-transform duration-300 z-[-1]"
              />
            ) : (
              <div class="absolute top-0 w-full h-full bg-gray-200 flex items-center justify-center z-[-1]">
                <p class="text-gray-600">Image non disponible</p>
              </div>
            )}
            <div class="absolute flex flex-col bottom-0 left-0 w-full text-center bg-gradient-to-t from-[#af7749] to-transparent p-6 rounded-b-2xl z-20">
              <p class="text-white font-vibes text-xl md:text-2xl mb-4 drop-shadow-lg">
                {dress.dressName}
              </p>
              <button class="bg-[#C5A880] hidden md:block text-sm text-white font-semibold px-2 md:px-6 py-3 rounded-full shadow-lg hover:bg-[#A27E5D] transition-all">
                D√©couvrir cette robe
              </button>
            </div>
          </a>
        ))
      }
    </div>
  </div>

  <!-- Init du slider et zoom -->
  <script defer>
    document.addEventListener("DOMContentLoaded", function () {
      const swiper = new Swiper(".swiper-container", {
        loop: true,
        slidesPerView: 1,
        spaceBetween: 10,
        autoplay: { delay: 3000 },
      });

      function setupZoom() {
        const imgs = document.querySelectorAll(".swiper-slide img");
        imgs.forEach((img) => {
          img.style.cursor = "zoom-in";
          img.addEventListener("click", function () {
            swiper.autoplay.stop();
            const overlay = document.createElement("div");
            overlay.className =
              "fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50";
            const zoomed = document.createElement("img");
            zoomed.src = this.src;
            zoomed.style.maxWidth = "90%";
            zoomed.style.maxHeight = "90%";
            zoomed.style.objectFit = "contain";
            const closeBtn = document.createElement("button");
            closeBtn.innerText = "‚úñ";
            closeBtn.className = "absolute top-4 right-4 text-white text-2xl";
            overlay.appendChild(zoomed);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
            document.body.style.overflow = "hidden";
            closeBtn.onclick = () => {
              document.body.removeChild(overlay);
              document.body.style.overflow = "";
              swiper.autoplay.start();
            };
          });
        });
      }
      setTimeout(setupZoom, 500);
    });
  </script>

  <style>
    .fade-in {
      opacity: 0;
      transform: translateY(10px);
      transition:
        opacity 0.6s,
        transform 0.6s;
    }
    .fade-in.active {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</Layout>
