---
import Header from "../components/Header.astro";
import SocialIcons from "../components/SocialIcons.astro";
import FAQAccordion from "../components/FAQAccordion.astro";
import Layout from "../layouts/Layout.astro";

// Jours d'ouverture pour la carte des horaires
const joursSemaine = [
  "Lundi",
  "Mardi",
  "Mercredi",
  "Jeudi",
  "Vendredi",
  "Samedi",
];
---

<Layout>
  <div class="container mx-auto my-[70px]">
    <!-- Disposition horizontale -->
    <div class="mt-[100px] md:mt-0 flex-col w-full flex md:flex-row">
      <!-- COLONNE GAUCHE -->
      <div
        class="md:w-1/2 w-full relative overflow-hidden"
        style="background-image: url('/contact.jpg'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute top-0 left-0 w-full h-full"
          style="background-color: rgba(181, 116, 75, 0.7);"
        >
        </div>
        <div class="relative z-10 p-6">
          <SocialIcons iconColor="white" center="center" />
        </div>
        <div class="rounded-lg shadow-md p-8 max-w-xl mx-auto relative z-10">
          <h1
            class="font-vibes text-center text-5xl font-script text-white mb-2"
          >
            Monica Mariage
          </h1>
          <div
            class="rounded-lg p-6 shadow-sm mb-2 text-center text-white space-y-2"
          >
            <p class="font-medium">1220 Chemin de Brouquère</p>
            <p>31600 Seysses</p>
            <div class="my-4 border-t border-[#53240f]/20 pt-4">
              <p class="font-medium">06 68 30 09 60</p>
              <p class="text-sm">(Heure d'appel 9h-20h)</p>
            </div>
            <a
              href="mailto:monicamariage@hotmail.com"
              class="text-white
            hover:text-[#8B4513] underline decoration-dotted"
              >monicamariage@hotmail.com
            </a>
          </div>

          <!-- Horaires d'ouverture -->
          <div class="mt-8 text-white">
            <h3 class="text-xl font-medium text-center mb-4">
              Horaires d'ouverture
            </h3>
            <div class="grid grid-cols-2 gap-2">
              {
                joursSemaine.map((jour) => (
                  <div class="text-center py-2 border-b border-[#53240f]/20">
                    <span class="font-medium">{jour}</span>
                    <p>9h - 19h</p>
                  </div>
                ))
              }
            </div>
            <p class="text-center mt-4 text-sm italic">
              Sur rendez-vous uniquement
            </p>
          </div>
        </div>
      </div>

      <!-- COLONNE DROITE -->
      <div class="w-full md:w-1/2 bg-[rgba(181,116,75,0.7)] p-6 rounded-lg">
        <h2 class="text-center text-2xl font-script text-white mb-6">
          Contactez-moi
        </h2>

        <form id="contactForm" class="space-y-4">
          <input
            type="text"
            placeholder="Nom *"
            class="w-full p-2 border border-gray-300 rounded"
            name="name"
            required
          />
          <input
            type="email"
            placeholder="Email *"
            class="w-full p-2 border border-gray-300 rounded"
            name="email"
            required
          />
          <input
            type="tel"
            placeholder="Portable *"
            class="w-full p-2 border border-gray-300 rounded"
            name="phone"
            required
          />
          <input
            type="text"
            placeholder="Date du mariage *"
            class="w-full p-2 border border-gray-300 rounded"
            name="dateMariage"
            required
          />
          <input
            type="text"
            id="taille-input"
            placeholder="Taille"
            class="w-full p-2 border border-gray-300 rounded"
            readonly
            name="taille"
          />
          <input
            type="text"
            placeholder="Forme préférée"
            class="w-full p-2 border border-gray-300 rounded"
            name="forme"
          />
          <input
            type="text"
            placeholder="Budget défini *"
            class="w-full p-2 border border-gray-300 rounded"
            name="budget"
            required
          />
          <textarea
            placeholder="Message *"
            class="w-full p-2 border border-gray-300 rounded h-32"
            name="message"
            required></textarea>
          <button
            type="submit"
            class="bg-[#53240f] text-white px-6 py-2 rounded hover:bg-[#6b2f13] w-full"
            >Envoyer</button
          >
        </form>
      </div>
    </div>
  </div>
  <FAQAccordion />

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const contactForm = document.getElementById("contactForm");

      contactForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {
          name: document.querySelector('input[name="name"]').value || "",
          email: document.querySelector('input[name="email"]').value || "",
          phone: document.querySelector('input[name="phone"]').value || "",
          dateMariage:
            document.querySelector('input[name="dateMariage"]').value || "",
          taille: document.querySelector('input[name="taille"]').value || "",
          forme: document.querySelector('input[name="forme"]').value || "",
          budget: document.querySelector('input[name="budget"]').value || "",
          message:
            document.querySelector('textarea[name="message"]').value || "",
        };

        const submitButton = document.querySelector('button[type="submit"]');
        submitButton.textContent = "Envoi en cours...";
        submitButton.disabled = true;

        // Vérifier si c'est un environnement local pour faciliter les tests
        if (window.location.hostname === "localhost") {
          // Simuler un succès sans faire d'appel réseau
          console.log("Mode local : simulation d'envoi d'email", formData);
          alert("✔️ [TEST LOCAL] Message simulé avec succès !");
          submitButton.textContent = "Envoyer";
          submitButton.disabled = false;
          contactForm.reset();

          // Préparer message WhatsApp (pour test)
          const whatsappMessage = encodeURIComponent(
            `Bonjour Monica Mariage,\n\nJe suis ${formData.name},\nEmail: ${formData.email},\nDate du mariage: ${formData.dateMariage},\nForme préférée: ${formData.forme},\nBudget: ${formData.budget},\nMessage: ${formData.message}`
          );

          // Redirection vers WhatsApp
          window.location.href = `https://wa.me/33668300960?text=${whatsappMessage}`;
          return;
        }

        try {
          const response = await fetch(
            "https://monica-mariage-next.vercel.app/api/send-info",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          if (!response.ok) {
            console.error(
              "Erreur HTTP :",
              response.status,
              response.statusText
            );
            alert("Erreur lors de l'envoi. Veuillez réessayer plus tard.");
            submitButton.textContent = "Envoyer";
            submitButton.disabled = false;
            return;
          }

          // Si on arrive ici, l'email a été envoyé avec succès
          alert("✔️ Message envoyé avec succès !");
          submitButton.textContent = "Envoyer";
          submitButton.disabled = false;
          contactForm.reset();

          // // Préparer message WhatsApp
          // const whatsappMessage = encodeURIComponent(
          //   `Bonjour Monica Mariage,\n\nJe suis ${formData.name},\nEmail: ${formData.email},\nDate du mariage: ${formData.dateMariage},\nForme préférée: ${formData.forme},\nBudget: ${formData.budget},\nMessage: ${formData.message}`
          // );

          // // Redirection immédiate vers WhatsApp (au lieu du setTimeout)
          // window.location.href = `https://wa.me/33668300960?text=${whatsappMessage}`;

          // Vous pouvez aussi stocker les informations pour WhatsApp dans sessionStorage
          // pour les récupérer sur la page de succès
          sessionStorage.setItem(
            "whatsappMessage",
            encodeURIComponent(
              `Bonjour Monica Mariage,\n\nJe suis ${formData.name},\nEmail: ${formData.email},\nDate du mariage: ${formData.dateMariage},\nForme préférée: ${formData.forme},\nBudget: ${formData.budget},\nMessage: ${formData.message}`
            )
          );
          window.location.href = "/success"; // Mettez ici le chemin vers votre page de succès
          sessionStorage.setItem("phoneNumber", "33668300960");
        } catch (error) {
          console.error("Erreur réseau :", error);
          alert(
            "❌ Une erreur réseau s'est produite. Vérifiez votre connexion internet et réessayez."
          );
          submitButton.textContent = "Envoyer";
          submitButton.disabled = false;
        }
      });
    });
  </script>
</Layout>
