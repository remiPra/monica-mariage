---
import Header from "../components/Header.astro";
import SocialIcons from "../components/SocialIcons.astro";
import FAQAccordion from "../components/FAQAccordion.astro";
import Layout from "../layouts/Layout.astro";

// Jours d'ouverture pour la carte des horaires
const joursSemaine = [
  "Lundi",
  "Mardi",
  "Mercredi",
  "Jeudi",
  "Vendredi",
  "Samedi",
];
---

<Layout
  title="Monica Mariage - Contact"
  description="Réservez votre essayage de robe de mariée à Toulouse chez Monica Mariage. Notre équipe vous accompagne dans le choix de votre robe sur-mesure. Showroom à 15 min du centre de Toulouse"
>
  <script type="application/ld+json" slot="head">
    // ... Votre JSON-LD reste inchangé ...
  </script>

  <div class="container mx-auto my-[70px]">
    <!-- Disposition horizontale -->
    <div class="mt-[100px] md:mt-0 flex-col w-full flex md:flex-row">
      <!-- COLONNE GAUCHE (INCHANGÉE) -->
      <div
        class="md:w-1/2 w-full relative overflow-hidden"
        style="background-image: url('/contact.jpg'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute top-0 left-0 w-full h-full"
          style="background-color: rgba(93, 38, 2, 0.8);"
        >
        </div>
        <div class="relative z-10 p-6">
          <SocialIcons iconColor="white" />
        </div>
        <div class="rounded-lg shadow-md p-8 max-w-xl mx-auto relative z-10">
          <h1
            class="font-vibes text-center text-5xl font-script text-white mb-2"
          >
            Monica Mariage
          </h1>
          <div
            class="rounded-lg p-6 shadow-sm mb-2 text-center text-white space-y-2"
          >
            <p class="font-medium">1220 Chemin de Brouquère</p>
            <p>31600 Seysses</p>
            <div class="my-4 border-t border-[#53240f]/20 pt-4">
              <p class="font-medium">06 68 30 09 60</p>
              <p class="text-sm">(Heure d'appel 9h-20h)</p>
            </div>
            <a
              href="mailto:monicamariage@hotmail.com"
              class="text-white
            hover:text-[#8B4513] underline decoration-dotted"
              >monicamariage@hotmail.com
            </a>
          </div>
          <div class="mt-8 text-white">
            <h3 class="text-xl font-medium text-center mb-4">
              Horaires d'ouverture
            </h3>
            <div class="grid grid-cols-2 gap-2">
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Lundi</span>
                <p>12h - 19h</p>
              </div>
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Mardi</span>
                <p>14h - 19h</p>
              </div>
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Mercredi</span>
                <p>12h30 - 19h</p>
              </div>
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Jeudi</span>
                <p>Fermé</p>
              </div>
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Vendredi</span>
                <p>9h - 19h</p>
              </div>
              <div class="text-center py-2 border-b border-[#53240f]/20">
                <span class="font-medium">Samedi</span>
                <p>9h - 19h</p>
              </div>
            </div>
            <p class="text-center mt-4 text-sm italic">
              Sur rendez-vous uniquement
            </p>
          </div>
        </div>
      </div>

      <!-- COLONNE DROITE (FORMULAIRE MODIFIÉ) -->
      <div class="w-full md:w-1/2 bg-[rgba(131,82,50,0.8)] p-6 rounded-lg">
        <h2 class="text-center text-2xl font-script text-white mb-6">
          Contactez-moi
        </h2>

        <form id="contactForm" class="space-y-4" novalidate>
          <input type="text" placeholder="Nom *" class="w-full p-2 border border-gray-300 rounded" name="name" data-question="Quel est votre nom complet ?" />
          <input type="email" placeholder="Email *" class="w-full p-2 border border-gray-300 rounded" name="email" data-question="Quelle est votre adresse e-mail pour vous recontacter ?" />
          <input type="tel" placeholder="Portable *" class="w-full p-2 border border-gray-300 rounded" name="phone" data-question="Quel est votre numéro de téléphone ?" />
          <input type="text" placeholder="Date du mariage" class="w-full p-2 border border-gray-300 rounded" name="dateMariage" data-question="Quelle est la date prévue pour votre mariage ?" />
          <input type="text" placeholder="Taille (ex: 38, 40...)" class="w-full p-2 border border-gray-300 rounded" name="taille" data-question="Quelle est votre taille de confection habituelle ?" />
          <input type="text" placeholder="Forme préférée" class="w-full p-2 border border-gray-300 rounded" name="forme" data-question="Avez-vous une préférence pour la forme de la robe (sirène, princesse...) ?" />
          <input type="text" placeholder="Budget défini *" class="w-full p-2 border border-gray-300 rounded" name="budget" data-question="Quel est le budget que vous avez défini pour votre robe ?" />
          <textarea placeholder="Message *" class="w-full p-2 border border-gray-300 rounded h-32" name="message" data-question="Quel message souhaitez-vous nous adresser ?"></textarea>
          <button type="submit" class="bg-[#53240f] text-white px-6 py-2 rounded hover:bg-[#6b2f13] w-full">Envoyer</button>
        </form>
      </div>
    </div>
  </div>
  <FAQAccordion />

  <!-- MODÈLE DE MODALE COMPLEXE (INCHANGÉ) -->
  <div id="modal-template" class="modal-overlay" style="display: none;">
    <div class="modal-content relative">
      <span class="close-btn">&times;</span>
      <h3 id="modal-title" class="text-xl font-bold mb-2 text-center">Section non remplie</h3>
      <p id="modal-question" class="mb-4 text-center">Ah, il semble que vous n'ayez pas rempli cette section.</p>
      <div class="modal-actions space-y-3">
        <div class="flex">
          <input type="text" class="modal-input" placeholder="Renseignez votre choix ici...">
          <button class="modal-submit-btn">Valider</button>
        </div>
        <button class="modal-idk-btn w-full">Je ne sais pas</button>
      </div>
    </div>
  </div>

  <!-- STYLES POUR LA MODALE (INCHANGÉS) -->
  <style>
    .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .close-btn { position: absolute; top: 5px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: #000; }
    .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
    .modal-submit-btn { padding: 10px; background-color: #53240f; color: white; border: 1px solid #53240f; border-radius: 0 5px 5px 0; cursor: pointer; }
    .modal-idk-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background-color: #e2e8f0; color: #1a202c; }
  </style>

  <!-- SCRIPT FINAL -->
  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const contactForm = document.getElementById("contactForm");
      const modalTemplate = document.getElementById("modal-template");

      // Liste de tous les champs à vérifier, dans l'ordre
      const allFieldNames = ["name", "email", "phone", "dateMariage", "taille", "forme", "budget", "message"];

      const proceedWithSubmission = async () => {
        const formData = {};
        allFieldNames.forEach(name => {
            const element = contactForm.querySelector(`[name="${name}"]`);
            formData[name] = element ? element.value : '';
        });

        const submitButton = document.querySelector('button[type="submit"]');
        submitButton.textContent = "Envoi en cours...";
        submitButton.disabled = true;

        try {
          const response = await fetch("https://monica-mariage-next.vercel.app/api/send-info", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          alert("✔️ Message envoyé avec succès !");
          window.location.href = "/success"; // Redirige vers une page de succès
        } catch (error) {
          console.error("Erreur lors de l'envoi:", error);
          alert("❌ Une erreur s'est produite. Veuillez réessayer.");
        } finally {
          submitButton.textContent = "Envoyer";
          submitButton.disabled = false;
        }
      };

      const processModalQueue = (queue) => {
        if (queue.length === 0) {
          proceedWithSubmission();
          return;
        }
        const inputNameToProcess = queue.shift();
        const inputElement = contactForm.querySelector(`[name="${inputNameToProcess}"]`);
        showComplexModal(inputElement, () => processModalQueue(queue));
      };
      
      const showComplexModal = (inputElement, onModalCloseCallback) => {
        const newModal = modalTemplate.cloneNode(true);
        newModal.id = `modal-for-${inputElement.name}`;
        document.body.appendChild(newModal);

        const placeholder = inputElement.getAttribute('placeholder').replace(' *', '');
        const question = inputElement.dataset.question;
        
        newModal.querySelector('#modal-title').textContent = `${placeholder}`;
        newModal.querySelector('#modal-question').textContent = question;

        const modalInput = newModal.querySelector('.modal-input');
        const submitBtn = newModal.querySelector('.modal-submit-btn');
        const idkBtn = newModal.querySelector('.modal-idk-btn');
        const closeBtn = newModal.querySelector('.close-btn');

        newModal.style.display = 'flex';
        modalInput.focus();

        const closeModal = () => {
          newModal.remove();
          onModalCloseCallback();
        };

        submitBtn.onclick = () => {
          if (modalInput.value.trim() !== '') {
            inputElement.value = modalInput.value.trim();
            closeModal();
          } else {
            modalInput.style.borderColor = 'red';
          }
        };
        
        modalInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitBtn.click();
        });

        idkBtn.onclick = () => {
          inputElement.value = "Non renseigné";
          closeModal();
        };

        closeBtn.onclick = () => {
          newModal.remove(); 
        };
        
        newModal.addEventListener('click', (e) => {
            if (e.target === newModal) {
                 newModal.remove();
            }
        });
      };

      contactForm?.addEventListener("submit", (e) => {
        e.preventDefault();

        const emptyFields = allFieldNames.filter(fieldName => {
            const input = contactForm.querySelector(`[name="${fieldName}"]`);
            return input && !input.value.trim();
        });

        if (emptyFields.length > 0) {
          processModalQueue(emptyFields);
        } else {
          proceedWithSubmission();
        }
      });
    });
  </script>
</Layout>