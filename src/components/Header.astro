---
// Importation des composants Astro
import { Icon } from "astro-icon/components";
import SocialIcons from "./SocialIcons.astro"; // Assurez-vous que ce composant existe ou supprimez l'import s'il n'est pas utilisé ici
import FavoriDrawer from "./FavoriDrawer.astro";
import FavorisDrawerDesktop from "./FavorisDrawerDesktop.astro";

// Structure des sous-menus pour faciliter la maintenance
const robesSubMenuItems = [
  { href: "/robes-de-mariee/forme-princesse", text: "Forme Princesse" },
  { href: "/robes-de-mariee/style-boheme-chic", text: "Style Bohème Chic" },
  { href: "/robes-de-mariee/forme-sirene", text: "Style Sirène" },
  { href: "/robes-de-mariee/minimaliste", text: "Minimaliste" },
];

const promoSubMenuItems = [
  { href: "/promo/robes-de-mariee-promotion", text: "Flash Vente" },
  { href: "/promo/robes-de-mariee-boheme-chic", text: "Promotion Bohème" },
  { href: "/promo/promo-sirene", text: "Promotion Sirène" },
  { href: "/promo/robes-de-mariee-destockage", text: "Destockage" },
];
---

<header id="header" class="fixed top-0 w-full z-50 bg-[#FDE9E6] shadow-md">
  <!-- Barre de contact Mobile uniquement -->
  <div
    class="bg-[#A37B63] text-white text-sm py-2 px-4 flex justify-center lg:hidden"
  >
    <div class="flex items-center gap-2">
      <a
        href="https://wa.me/33668300960"
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-1"
      >
        <Icon name="mdi:whatsapp" class="text-2xl" />
      </a>
      <a
        href="https://wa.me/33668300960"
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-1 text-xl"
      >
        06 68 30 09 60
      </a>
      <a href="tel:+33668300960" class="flex items-center gap-1">
        <Icon name="mdi:phone" class="text-2xl" />
      </a>
    </div>
  </div>

  <!-- Navigation Desktop -->
  <nav
    class="hidden lg:flex bg-[#FDE9E6] items-center justify-between px-8 h-20"
  >
    <!-- Liens Gauche -->
    <div class="flex items-center space-x-8">
      <a
        href="/"
        class="flex items-center gap-1 text-[#7A5C4B] hover:text-[#A37B63]"
      >
        <Icon name="mdi:home-outline" />
        Accueil
      </a>
      <!-- Dropdown Robes de Mariée -->
      <div class="relative group">
        <button class="text-[#7A5C4B] hover:text-[#A37B63] focus:outline-none"
          >Robes de Mariée</button
        >
        <div
          class="absolute left-0 mt-2 w-48 bg-[#FDE9E6] shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10"
        >
          {
            robesSubMenuItems.map((item) => (
              <a
                href={item.href}
                class="block px-4 py-2 text-[#7A5C4B] hover:bg-[#A37B63] hover:text-white"
              >
                {item.text}
              </a>
            ))
          }
        </div>
      </div>
      <!-- Dropdown Promotions -->
      <div class="relative group">
        <button class="text-[#7A5C4B] hover:text-[#A37B63] focus:outline-none"
          >Promotions</button
        >
        <div
          class="absolute left-0 mt-2 w-48 bg-[#FDE9E6] shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10"
        >
          {
            promoSubMenuItems.map((item) => (
              <a
                href={item.href}
                class="block px-4 py-2 text-[#7A5C4B] hover:bg-[#A37B63] hover:text-white"
              >
                {item.text}
              </a>
            ))
          }
        </div>
      </div>
      <a href="/toutes-nos-robes" class="text-[#7A5C4B] hover:text-[#A37B63]"
        >Toutes nos robes</a
      >
    </div>

    <!-- Logo Central -->
    <div
      class="absolute left-1/2 transform -translate-x-1/2 flex flex-col items-center text-center"
    >
      <a href="/" class="inline-block">
        <p class="text-[#7A5C4B] font-vibes italic text-4xl">MonicaMariage</p>
        <span class="text-[#7A5C4B] italic text-md -mt-1 block">Since 2014</span
        >
      </a>
    </div>

    <!-- Liens Droite -->
    <div class="flex items-center space-x-8">
      <a href="/trouver-le-showroom" class="text-[#7A5C4B] hover:text-[#A37B63]"
        >Trouver le showroom</a
      >
      <a href="/prendre-rendez-vous">
        <button
          class="bg-[#7A5C4B] text-white hover:bg-[#A37B63] transition transform hover:scale-105 rounded-md py-2 px-4 shadow-lg"
        >
          Contactez Nous
        </button>
      </a>

      <FavorisDrawerDesktop />
    </div>
  </nav>

  <!-- Navigation Mobile -->
  <div
    class="lg:hidden bg-[#FDE9E6] shadow-md px-4 py-3 flex justify-between items-center"
  >
    <button
      id="mobileMenuBtn"
      aria-label="Ouvrir le menu"
      class="text-[#7A5C4B] p-1 border border-[#7A5C4B] rounded-full"
    >
      <Icon name="mdi:menu" class="w-7 h-7" />
      <!-- Slightly smaller icon -->
    </button>
    <a href="/" class="font-vibes text-3xl text-[#7A5C4B]">MonicaMariage</a>
    <div class="flex items-center space-x-2">
      <!-- Added space-x-2 -->
      <a
        href="/trouver-le-showroom"
        aria-label="Trouver le showroom"
        class="text-[#7A5C4B] p-1"
      >
        <Icon name="mdi:map-marker" class="w-7 h-7 text-[#7A5C4B]" />
      </a>
      <FavoriDrawer />
    </div>
  </div>

  <!-- Overlay -->
  <div
    id="menuOverlay"
    class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden transition-opacity duration-300"
  >
  </div>

  <!-- Menu Mobile Principal (Avec sous-menus intégrés) -->
  <div
    id="mobileMenu"
    class="fixed top-0 right-0 h-full w-4/5 max-w-sm bg-[#FDE9E6] z-50 p-4 overflow-y-auto flex flex-col shadow-lg transform translate-x-full opacity-0 transition-all duration-500 ease-in-out lg:hidden"
  >
    <!-- Entête du Menu Mobile -->
    <div class="flex justify-between items-center mb-6">
      <div class="text-center w-full font-semibold mt-[100px]">
        <a href="/">
          <span class="text-[#7A5C4B] block font-vibes italic text-[32px]"
            >MonicaMariage</span
          >
          <span class="text-[#7A5C4B] text-[16px] block -mt-1">Since 2014</span>
        </a>
      </div>
      <button
        id="closeMobileMenu"
        aria-label="Fermer le menu"
        class="border border-[#7A5C4B] rounded-full p-1 text-[#7A5C4B]"
      >
        <Icon name="mdi:close" class="w-7 h-7" />
      </button>
    </div>

    <!-- Liens du Menu Mobile -->
    <div
      class="flex flex-col space-y-2 font-semibold text-[#7A5C4B] w-full flex-grow"
    >
      <a
        href="/"
        class="flex items-center gap-3 py-2 hover:text-[#A37B63] transition w-full"
      >
        <Icon name="mdi:home-outline" class="text-2xl" />
        <span class="font-cormorant text-xl">Accueil</span>
      </a>

      <!-- Section Robes de Mariée (Toggle) -->
      <div class="w-full">
        <button
          id="toggleRobesSubmenu"
          aria-expanded="false"
          aria-controls="robesSubmenuContainer"
          class="flex items-center justify-between gap-3 py-2 hover:text-[#A37B63] transition w-full text-left"
        >
          <span class="flex items-center gap-3">
            <Icon name="mdi:hanger" class="text-2xl" />
            <span class="font-cormorant text-xl">Robes de Mariée</span>
          </span>
          <Icon
            name="mdi:chevron-down"
            class="text-xl transition-transform duration-300"
            data-arrow="toggleRobesSubmenu"
          />
        </button>
        <div
          id="robesSubmenuContainer"
          class="overflow-hidden transition-all duration-500 ease-in-out max-h-0 pl-8"
          style="/* max-h set via JS */"
        >
          <div class="flex flex-col space-y-1 pt-1">
            {
              robesSubMenuItems.map((item) => (
                <a
                  href={item.href}
                  class="block py-1 text-[#7A5C4B] hover:text-[#A37B63] transition font-cormorant text-lg"
                >
                  {item.text}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Section Promotions (Toggle) -->
      <div class="w-full">
        <button
          id="togglePromoSubmenu"
          aria-expanded="false"
          aria-controls="promoSubmenuContainer"
          class="flex items-center justify-between gap-3 py-2 hover:text-[#A37B63] transition w-full text-left"
        >
          <span class="flex items-center gap-3">
            <Icon name="mdi:percent-outline" class="text-2xl" />
            <span class="font-cormorant text-xl">Promotions</span>
          </span>
          <Icon
            name="mdi:chevron-down"
            class="text-xl transition-transform duration-300"
            data-arrow="togglePromoSubmenu"
          />
        </button>
        <div
          id="promoSubmenuContainer"
          class="overflow-hidden transition-all duration-500 ease-in-out max-h-0 pl-8"
          style="/* max-h set via JS */"
        >
          <div class="flex flex-col space-y-1 pt-1">
            {
              promoSubMenuItems.map((item) => (
                <a
                  href={item.href}
                  class="block py-1 text-[#7A5C4B] hover:text-[#A37B63] transition font-cormorant text-lg"
                >
                  {item.text}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <a
        href="/toutes-nos-robes"
        class="flex items-center gap-3 py-2 hover:text-[#A37B63] transition w-full"
      >
        <Icon name="mdi:human-female-dance" class="text-2xl" /><span
          class="font-cormorant text-xl">Toutes nos robes</span
        >
      </a>

      <a
        href="/prendre-rendez-vous"
        class="flex items-center gap-3 py-2 hover:text-[#A37B63] transition w-full"
      >
        <Icon name="mdi:calendar-check-outline" class="text-2xl" /><span
          class="font-cormorant text-xl">Prendre Rendez-Vous</span
        >
      </a>
      <a
        href="/trouver-le-showroom"
        class="flex items-center gap-3 py-2 hover:text-[#A37B63] transition w-full"
      >
        <Icon name="mdi:map-marker-outline" class="text-2xl" /><span
          class="font-cormorant text-xl">Trouver le showroom</span
        >
      </a>
    </div>

    <!-- Pied de page du Menu Mobile (Social) -->
    <div class="mt-auto pt-6">
      {/* mt-auto pousse ce div vers le bas */}
      <div class="flex justify-center gap-6 text-[#7A5C4B] text-3xl">
        <a
          href="https://wa.me/33668300960"
          target="_blank"
          aria-label="WhatsApp"><Icon name="mdi:whatsapp" /></a
        >
        <a
          href="https://www.instagram.com"
          target="_blank"
          aria-label="Instagram"><Icon name="mdi:instagram" /></a
        >
        <a
          href="https://www.messenger.com"
          target="_blank"
          aria-label="Messenger"><Icon name="mdi:facebook-messenger" /></a
        >
        <a href="tel:+33668300960" aria-label="Téléphone"
          ><Icon name="mdi:phone" /></a
        >
      </div>
    </div>
  </div>

  <!-- SUPPRIMÉS: Les anciens div #mobileSubmenu et #mobilePromoSubmenu ne sont plus nécessaires -->
</header>

<script
  define:vars={{
    robesSubmenuId: "robesSubmenuContainer",
    promoSubmenuId: "promoSubmenuContainer",
  }}
>
  document.addEventListener("DOMContentLoaded", () => {
    const mobileMenu = document.getElementById("mobileMenu");
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const closeMobileMenu = document.getElementById("closeMobileMenu");
    const menuOverlay = document.getElementById("menuOverlay");

    const toggleRobesBtn = document.getElementById("toggleRobesSubmenu");
    const robesSubmenu = document.getElementById(robesSubmenuId); // Utilisation de define:vars
    const togglePromoBtn = document.getElementById("togglePromoSubmenu");
    const promoSubmenu = document.getElementById(promoSubmenuId); // Utilisation de define:vars

    // Fonction pour ouvrir le menu principal
    const openMainMenu = () => {
      mobileMenu.classList.replace("translate-x-full", "translate-x-0");
      mobileMenu.classList.replace("opacity-0", "opacity-100");
      menuOverlay.classList.remove("hidden");
      document.body.style.overflow = "hidden"; // Empêche le scroll de la page derrière
    };

    // Fonction pour fermer le menu principal (et réinitialiser les sous-menus)
    const closeMainMenu = () => {
      mobileMenu.classList.replace("translate-x-0", "translate-x-full");
      mobileMenu.classList.replace("opacity-100", "opacity-0");
      menuOverlay.classList.add("hidden");
      document.body.style.overflow = ""; // Réactive le scroll

      // Fermer tous les sous-menus quand le menu principal se ferme
      closeSubmenu(robesSubmenu, toggleRobesBtn);
      closeSubmenu(promoSubmenu, togglePromoBtn);
    };

    // Fonction pour ouvrir un sous-menu
    const openSubmenu = (submenu, button) => {
      const arrow = button.querySelector("[data-arrow]");
      submenu.style.maxHeight = submenu.scrollHeight + "px"; // Définit la hauteur max à la hauteur du contenu
      button.setAttribute("aria-expanded", "true");
      if (arrow) arrow.classList.add("rotate-180");
    };

    // Fonction pour fermer un sous-menu
    const closeSubmenu = (submenu, button) => {
      const arrow = button.querySelector("[data-arrow]");
      submenu.style.maxHeight = "0px"; // Réduit la hauteur max à 0
      button.setAttribute("aria-expanded", "false");
      if (arrow) arrow.classList.remove("rotate-180");
    };

    // Fonction pour gérer le clic sur un bouton de toggle
    const handleToggleClick = (button, submenu, otherButton, otherSubmenu) => {
      const isOpening =
        submenu.style.maxHeight === "0px" || !submenu.style.maxHeight;

      // Fermer l'autre sous-menu s'il est ouvert
      if (
        isOpening &&
        otherSubmenu.style.maxHeight !== "0px" &&
        otherSubmenu.style.maxHeight
      ) {
        closeSubmenu(otherSubmenu, otherButton);
      }

      // Ouvrir ou fermer le sous-menu cliqué
      if (isOpening) {
        openSubmenu(submenu, button);
      } else {
        closeSubmenu(submenu, button);
      }
    };

    // Écouteurs d'événements
    mobileMenuBtn.addEventListener("click", openMainMenu);
    closeMobileMenu.addEventListener("click", closeMainMenu);
    menuOverlay.addEventListener("click", closeMainMenu); // Ferme aussi en cliquant sur l'overlay

    toggleRobesBtn.addEventListener("click", () => {
      handleToggleClick(
        toggleRobesBtn,
        robesSubmenu,
        togglePromoBtn,
        promoSubmenu
      );
    });

    togglePromoBtn.addEventListener("click", () => {
      handleToggleClick(
        togglePromoBtn,
        promoSubmenu,
        toggleRobesBtn,
        robesSubmenu
      );
    });

    // --- Logique Favoris (inchangée) ---
    function updateHeaderFavorisCounters() {
      try {
        const favoris = JSON.parse(
          localStorage.getItem("favoriteRobes") || "[]"
        ).length;
        // Met à jour tous les compteurs trouvés
        document
          .querySelectorAll("#favoris-count, #favorites-count")
          .forEach((el) => {
            if (el) el.textContent = favoris;
          });
        // Mise à jour spécifique pour les compteurs dans les tiroirs (s'ils utilisent ces ID)
        const drawerCountMobile = document.querySelector(
          "#favoriDrawerContent #favoris-count"
        );
        if (drawerCountMobile) drawerCountMobile.textContent = favoris;
        const drawerCountDesktop = document.querySelector(
          "#favorisDrawerDesktopContent #favorites-count"
        );
        if (drawerCountDesktop) drawerCountDesktop.textContent = favoris;
      } catch (e) {
        console.error(
          "Erreur lors de la mise à jour du compteur de favoris:",
          e
        );
      }
    }
    // Appeler une première fois au chargement
    updateHeaderFavorisCounters();
    // Écouter les événements personnalisés pour mettre à jour
    window.addEventListener("favorisUpdated", updateHeaderFavorisCounters); // Pour le tiroir mobile
    window.addEventListener("favoritesUpdated", updateHeaderFavorisCounters); // Pour le tiroir desktop
  });
</script>
