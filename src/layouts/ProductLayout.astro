---
import Header from "../components/Header.astro";
import FloatingButton from "../components/FloatingButton.astro";
import FolatingButtonWhatsapp from "../components/FolatingButtonWhatsapp.astro";
import Footer from "../components/Footer.astro";
import AppointmentBar from "../components/AppointmentBar.astro";
import ImagePreloader from "../components/ImagePreloader.astro";
import "../styles/global.css";

const {
  title = "Monica Mariage - Boutique de Robes de MariÃ©e",
  description = "DÃ©couvrez nos robes de mariÃ©e sur-mesure Ã  Toulouse.",
  mainImageUrl = "",
  product,
  breadcrumbs = [],
  collection = false,
  canonicalUrl, // ðŸ‘ˆ Recevoir l'URL canonique
  ...rest
} = Astro.props;

const analyticsId = "G-H8RDXC45EX";

// ðŸ‘‡ Utiliser l'URL canonique passÃ©e, JAMAIS Astro.url.href en production
const finalCanonicalUrl = canonicalUrl || 'https://monicamariage.com';

// Fonction pour nettoyer le HTML
function cleanDescription(desc) {
  if (!desc) return "";
  return desc.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}

let jsonLdData = {};

if (collection && product?.items) {
  // JSON-LD pour les collections
  jsonLdData = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": product.collectionName || title,
    "description": cleanDescription(description),
    "url": finalCanonicalUrl,
    "mainEntity": {
      "@type": "ItemList",
      "name": product.collectionName || "Collection Monica Mariage",
      "numberOfItems": product.items.length,
      "itemListElement": product.items.map((item, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "item": {
          "@type": "Product",
          "name": item.dressName || item.name,
          "url": `https://monicamariage.com/robes-de-mariee/${item.sousCategorie}/${item.slug}`,
          "image": item.image || item.imagesCloudinary?.[0]?.url,
          "brand": { "@type": "Brand", "name": "Monica Mariage" },
          "category": "Robes de mariÃ©e",
          "offers": {
            "@type": "Offer",
            "availability": "https://schema.org/InStock",
            "priceCurrency": "EUR",
            "price": "1200.00"
          }
        }
      }))
    },
    ...(breadcrumbs.length > 0 && {
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": breadcrumbs.map((crumb, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "name": crumb.name,
          "item": crumb.url
        }))
      }
    })
  };
} else if (product && !collection) {
  // JSON-LD pour un produit individuel
  const cleanedDescription = cleanDescription(product.descriptionCourte || product.metaDescription || description);

  jsonLdData = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.dressName || product.name,
    "description": cleanedDescription,
    "image": product.imagesCloudinary?.map(img => img.url).filter(Boolean) || [],
    "brand": { 
      "@type": "Brand", 
      "name": "Monica Mariage", 
      "url": "https://monicamariage.com" 
    },
    "category": "Robes de mariÃ©e",
    "additionalProperty": [
      ...(product.sousCategorie && [{
        "@type": "PropertyValue", 
        "name": "Style",
        "value": product.sousCategorie.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
      }]),
      { "@type": "PropertyValue", "name": "Collection", "value": "2025" },
      { "@type": "PropertyValue", "name": "Condition", "value": "Nouveau" }
    ].filter(Boolean),
    "offers": {
      "@type": "Offer",
      "url": finalCanonicalUrl,
      "priceCurrency": "EUR",
      "price": "1200.00",
      "priceRange": "750â‚¬-1850â‚¬",
      "availability": "https://schema.org/InStock",
      "itemCondition": "https://schema.org/NewCondition",
      "seller": {
        "@type": "Organization", 
        "name": "Monica Mariage", 
        "url": "https://monicamariage.com",
        "telephone": "+33668300960",
        "address": {
          "@type": "PostalAddress", 
          "streetAddress": "1220 chemin de brouquere", 
          "addressLocality": "Seysses",
          "addressRegion": "Occitanie", 
          "postalCode": "31600", 
          "addressCountry": "FR"
        }
      }
    },
    "manufacturer": { 
      "@type": "Organization", 
      "name": "Monica Mariage", 
      "url": "https://monicamariage.com" 
    },
    "aggregateRating": {
      "@type": "AggregateRating", 
      "ratingValue": "4.8", 
      "reviewCount": "150",
      "bestRating": "5", 
      "worstRating": "1"
    },
    ...(breadcrumbs.length > 0 && {
      "breadcrumb": {
        "@type": "BreadcrumbList",  
        "itemListElement": breadcrumbs.map((crumb, index) => ({
          "@type": "ListItem", 
          "position": index + 1, 
          "name": crumb.name, 
          "item": crumb.url
        }))
      }
    })
  };
}
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="rq53avWhuLrrx3ABvRJ12myweeaU47sTzsWdbNOatsU" />
    
    <!-- Titre et description -->
    <title>{title}</title>
    <meta name="description" content={description} />
    
    <!-- ðŸ‘‡ URL canonique et Open Graph CORRIGÃ‰ES -->
    <link rel="canonical" href={finalCanonicalUrl} />
    <meta property="og:url" content={finalCanonicalUrl} />
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://monicamariage.com/images/cover-robes.jpg" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Monica Mariage" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://monicamariage.com/images/cover-robes.jpg" />
    
    <!-- Robots et autres meta -->
    <meta name="robots" content="index, follow" />
    <link rel="alternate" type="text/plain" href="/llms.txt" title="LLMs Optimization Data" />

    <!-- Preload des polices -->
    <link rel="preload" href="/fonts/great-vibes-v19-latin-regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/cormorant-garamond-v19-latin-regular.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- PrÃ©chargement d'image principale si fournie -->
    {mainImageUrl && <ImagePreloader imageUrl={mainImageUrl} />}
    
    <!-- JSON-LD structurÃ© -->
   {Object.keys(jsonLdData).length > 0 && (
     <script type="application/ld+json" set:html={JSON.stringify(jsonLdData, null, 2)} />
   )}
   
   <slot name="head" />
 </head>
 <body>
   <Header />
   <slot />
   <FolatingButtonWhatsapp />
   <Footer />
   <AppointmentBar />
 </body>

 <!-- Script Google Analytics -->
 <script define:vars={{ analyticsId }}>
   // Configuration Google Analytics
   window.dataLayer = window.dataLayer || [];
   window.gtag = function () { dataLayer.push(arguments); };
   window.ga4Loaded = false;

   window.sendGa4Event = function (eventName, params = {}) {
     if (window.ga4Loaded) {
       gtag("event", eventName, params);
     } else {
       document.addEventListener("ga4Ready", () => gtag("event", eventName, params), { once: true });
     }
   };

   // Chargement diffÃ©rÃ© de Google Analytics
   setTimeout(() => {
     const script = document.createElement("script");
     script.async = true;
     script.src = `https://www.googletagmanager.com/gtag/js?id=${analyticsId}`;
     document.head.appendChild(script);
     script.onload = () => {
       gtag("js", new Date());
       gtag("config", analyticsId);
       window.ga4Loaded = true;
       document.dispatchEvent(new Event("ga4Ready"));
     };
   }, 4000);
 </script>
</html>